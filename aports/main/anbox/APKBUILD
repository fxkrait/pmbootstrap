pkgname=anbox
pkgver=0_git20180304
pkgrel=0
_commit="f68725cff813700e448fb3b2f3d57d88e2c7daae"
pkgdesc="Android in a box"
url="https://github.com/anbox/anbox"
arch="all"
license="GPLv3"
# FIXME: most of these depends should be detected automatically
# by abuild (it detects libraries linked against as depends)
# Also the -dev packages should be moved to makedepends?
depends="
	anbox-image
	boost
	boost-filesystem
	boost-iostreams
	boost-program_options
	boost-system
	dbus-libs
	glib
	glm-dev
	lxc-dev
	libexecinfo-dev
	mesa-gles
	mesa-egl
	protobuf-c
	properties-cpp-dev
	sdl2
	sdl2_image"
makedepends="
	boost-dev
	cmake
	dbus-cpp-dev
	glib-dev
	libcap-dev
	mesa-dev
	protobuf-dev
	protobuf-c-dev
	sdl2-dev
	sdl2_image-dev"
install=""
subpackages=""
source="
	$pkgname-${_commit}.tar.gz::https://github.com/anbox/anbox/archive/${_commit}.tar.gz
	anbox.initd
	anbox.confd
	boost_io_context.patch
	disable-tests.patch
	musl-fixes.patch
	anbox-launch.sh
	anbox.desktop
	"
builddir="$srcdir/$pkgname-$_commit"

prepare() {
	cd "$builddir"
	default_prepare
	mkdir -p "$builddir/build"

	# Remove -Werror
	sed -i s/-Werror//g CMakeLists.txt
}

build() {
	cd "$builddir/build"
	if [ "$CBUILD" != "$CHOST" ]; then
		CMAKE_CROSSOPTS="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=True \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_CXX_FLAGS="$CXXFLAGS" \
		-DCMAKE_C_FLAGS="$CFLAGS" \
		${CMAKE_CROSSOPTS} ..

	# Parallel building breaks it
	make -j1
}

package() {
	cd "$builddir/build"
	make DESTDIR="$pkgdir" install

	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
	install -m644 -D "$builddir"/kernel/99-anbox.rules \
		"$pkgdir"/lib/udev/rules.d/99-anbox.rules
	install -m644 -D "$srcdir"/$pkgname-launch.sh \
		"$pkgdir"/usr/bin/$pkgname-launch
	install -m644 -D "$srcdir"/$pkgname.desktop \
		"$pkgdir"/usr/share/applications/$pkgname.desktop
}

sha512sums="70e1a422f86636f4926a7bc541c4516e4ef1ade79a835f6e7e1a3facb145816ca6efe4bab1eced14c0b26c160d8f0347fb60469c63cb6a22678e43140a76c315  anbox-f68725cff813700e448fb3b2f3d57d88e2c7daae.tar.gz
c586f1bb7e3996a30a250317ad88cdc1f7dbc2bb75e740fa703662bde5e375151f11b5682e117e053e5ec95f48b8f5cda120cea709aa98a765814427513bda3c  anbox.initd
6a3bc88142c5287ec54d481a4788eceb7772d9974af950b5286ce63a49d05d9d49fce5ba1d02b4b1c9893896fd4ba218fd4d39b8e640bdd61ad196b5d5c9a021  anbox.confd
8092bfb6a86da1a3fd26d3001665a37fbf354b65a5ffbd0d73795c0cb9bc69b6bc3e8c7caef13990af85e2e690c762e553af58f78c0f1e8533634f894ab2c30c  boost_io_context.patch
3351edbd50370f514e405f10584264b110cd3d5eff766185b23d4c7e885933f0378330df5222fbd4b5161ff81f292ea63b4940f4afb1c457a2511fe8b5110195  disable-tests.patch
bb4baccf8801b700fe105b7414f80bb95ed19023cd8552d3d57620d981a67efc29505b62d469d29773d4c27cc3bdc3674ca09dff6f0ae7141a1c26fd6ec20bc4  musl-fixes.patch
93994207cd98792c747f80a807226c5fdf3e7cfc02490642c561330bcbf739ac7a65c1dd4634a1891d06d8624abb62bffc028fff7226fd1843a60ce630379893  anbox-launch.sh
de4d71d13c180db348fe9c839cd08e3764b9363f7404ea739f78d2c30f0a10ade437ec3518eec895a4cf3a34af70a46d55a2836ac8ca1247a237071e505317fa  anbox.desktop"
